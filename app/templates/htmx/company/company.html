{% block header %}
{% endblock %}

{% block content %}
    <br>
    <h3 class="title is-3">Dados da empresa</h3>
    <div class="box">

        <div class="fixed-grid has-1-cols">
            <div class="grid">
                <div class="cell"><span class="tag is-medium">Nome: {{ company.name }}</span></div>
                <div class="cell"><span class="tag is-medium">Descrição: {{company.description}}</span></div>
                <div class="cell"><span class="tag is-medium">Endereço: {{ company.address }}</span></div>
                <div class="cell"><span class="tag is-medium">VatCode(NIF): {{company.vatcode}}</span></div>
            </div>
        </div>
    </div>

    <div class="columns">
        <div class="column">
            <span class="title is-3">Colaboradores</span>
            <span class="icon has-text-info">
                <button class="fas fa-info-circle" onclick="tutorial('employees');"></button>
            </span>
        </div>
        <div class="column">
            <div align="right">
                {% if current_user.userTypeId == 1 %}
                <button id="addEmployee" class="button" hx-target="#addUser" hx-swap="innerHTML"
                    hx-get="/signup_worker/{{company.id}}" data-loading-class="is-loading"><p><i class="fa-solid fa-plus fa-lg"></i> <i class="fa-solid fa-user fa-lg"></i></p></button>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="workers" class="box">

            {% for worker in users_company %}
            <p>{{worker.name}} (Ident.(NIF) {{worker.userIdentification}})</p>
            {% endfor %}
    </div>
    
    <div id="addUser"></div>
    <div class="columns">
        <div class="column">
            <span class="title is-3">Veículos</span>
            <span class="icon has-text-info">
                <button class="fas fa-info-circle" onclick="tutorial('vehicles');"></button>
            </span>
        </div>
        <div class="column">
            <div align="right">
                {% if current_user.userTypeId == 1 %}
                <button id="addVehicle" class="button" hx-target="#addCar" hx-swap="innerHTML"
                    hx-get="/vehicle/add/{{company.id}}" data-loading-class="is-loading"><p><i class="fa-solid fa-plus fa-lg"></i> <i class="fa-solid fa-car fa-lg"></i></p></button>
                
                {% endif %}
            </div>
        </div>
    </div>

    <div class="box" id="vehicles">
        {% for vehicle in vehicles_company %}
        {% if vehicle %}
        <p>{{vehicle.model}} ({{vehicle.licensePlate}})</p>
        {% endif %}
        {% endfor %}
    </div>
    <div id="addCar"></div>
    
    <h3 class="title is-3">Mapa</h3>

    <div id="map" x-data="mapData()" x-init="initMap" style="height: 400px;"></div>
    <script>
        function mapData() {
            return {
                map: null,
                markers: [],

                async initMap() {
                    // Initialize Leaflet map
                    this.map = L.map('map');

                    // Add Tile layer to the map
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 16,
                    }).addTo(this.map);

                    // Fetch marker data from API
                    try {
                        const response = await fetch('/geolocation/list/{{company.id}}');
                        const data = await response.json();
                        this.markers = data;
                        // Add markers to the map
                        this.markers.forEach(marker => {
                            L.marker([marker.latitude, marker.longitude]).addTo(this.map)
                                .bindPopup(marker.userName+' ['+marker.model+'] ['+marker.eventCategory+']')
                                .openPopup();
                        });
                        const bounds = this.markers.map(marker => [marker.latitude, marker.longitude]);
                        this.map.fitBounds(bounds);
                    } catch (error) {
                        console.error('Error fetching marker data:', error);
                    }
                }
            };
        }
    </script>
</div>
{% endblock %}